{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2018/4/13/013.\n */\n\nimport Bluebird from 'bluebird';\nimport { LF } from 'crlf-normalize';\nimport { wrapStreamToPromise, IStreamLineWithValue } from '@novel-segment/stream-loader-core/line';\nimport createLoadStream, { ICallback } from '@novel-segment/stream-loader-core/stream';\nimport createLoadStreamSync from '@novel-segment/stream-loader-core/sync';\nimport { autobind } from 'core-decorators';\n\nexport type IOptions<T, R> = {\n\n\tparseLine?(input: string, oldFn?: (input: string) => R): R,\n\n\tmapper?(line),\n\n\tfilter?(line),\n\n\tstringifyLine?(data: R): string,\n\n};\n\n@autobind\nexport class LoaderClass<T, R>\n{\n\tpublic default = this.load;\n\tprotected defaultOptions: IOptions<T, R>;\n\n\tconstructor(options: IOptions<T, R> = {}, ...argv)\n\t{\n\t\tif (options.parseLine)\n\t\t{\n\t\t\tthis.parseLine = options.parseLine.bind(this);\n\t\t}\n\n\t\tif (options.stringifyLine)\n\t\t{\n\t\t\tthis.stringifyLine = options.stringifyLine.bind(this);\n\t\t}\n\n\t\tif (options.filter)\n\t\t{\n\t\t\tthis.filter = options.filter.bind(this);\n\t\t}\n\n\t\tif (options.mapper)\n\t\t{\n\t\t\tthis.defaultOptions.mapper = options.mapper.bind(this);\n\t\t}\n\t}\n\n\tstatic create(options: IOptions<any, any> = {}, ...argv)\n\t{\n\t\treturn new this(options, ...argv);\n\t}\n\n\tparseLine(input: string): R\n\t{\n\t\treturn input as any as R\n\t}\n\n\tstringifyLine(data: R): string\n\t{\n\t\treturn data.toString();\n\t}\n\n\tserialize(data: R[]): string\n\t{\n\t\tlet self = this;\n\n\t\treturn data.map(function (d)\n\t\t{\n\t\t\treturn self.stringifyLine(d);\n\t\t}).join(LF);\n\t}\n\n\tfilter(input: string)\n\t{\n\t\treturn input\n\t}\n\n\tload(file: string, options: IOptions<T, R> = {}): Bluebird<T>\n\t{\n\t\treturn wrapStreamToPromise(this.loadStream(file, options))\n\t\t\t.then(function (stream: IStreamLineWithValue<T>)\n\t\t\t{\n\t\t\t\treturn stream.value;\n\t\t\t})\n\t\t\t;\n\t}\n\n\tloadSync(file: string, options: IOptions<T, R> = {})\n\t{\n\t\tlet r = this.loadStreamSync(file, options);\n\t\tlet value = r.value;\n\t\t// 試圖手動清除記憶體占用\n\t\tr = undefined;\n\t\treturn value;\n\t}\n\n\tloadStream(file: string, options: IOptions<T, R> = {}, callback?: ICallback<T>)\n\t{\n\t\treturn this._createStream(createLoadStream, file, options, callback)\n\t}\n\n\tloadStreamSync(file: string, options: IOptions<T, R> = {}, callback?: ICallback<T>)\n\t{\n\t\treturn this._createStream(createLoadStreamSync, file, options, callback)\n\t}\n\n\tprotected _createStream<T>(fnStream: typeof createLoadStream,\n\t\tfile: string,\n\t\toptions: IOptions<T, R> = {},\n\t\tcallback?: ICallback<T>\n\t)\n\t{\n\t\tlet self = this;\n\n\t\tlet opts = Object.assign({}, this.defaultOptions, options);\n\n\t\tlet parseLine = opts.parseLine || self.parseLine;\n\t\tlet filter = opts.filter || self.filter;\n\n\t\topts.parseLine = parseLine;\n\n\t\tlet stream = fnStream<T>(file, {\n\n\t\t\tcallback,\n\n\t\t\tmapper: opts.mapper || function mapper(line)\n\t\t\t{\n\t\t\t\tif (filter)\n\t\t\t\t{\n\t\t\t\t\tline = filter(line);\n\t\t\t\t}\n\n\t\t\t\tif (line)\n\t\t\t\t{\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\treturn parseLine(line, self.parseLine);\n\t\t\t\t}\n\t\t\t},\n\n\t\t});\n\n\t\t// @ts-ignore\n\t\tstream.pipeLoader = self;\n\t\t// @ts-ignore\n\t\tstream.pipeRuntimeOptions = opts;\n\n\t\treturn stream;\n\t}\n}\n\nexport default LoaderClass;\n"]}